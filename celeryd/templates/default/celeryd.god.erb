# Generated by Chef

celeryd_list = Array.new
Dir["/etc/init.d/celeryd-<%= @name %>_*"].each do |file|
  celeryd = Hash.new
  celeryd[:name] = "#{file}"
  celeryd[:start] = "#{file} start"
  celeryd[:stop] = "#{file} stop"
  celeryd[:restart] = "#{file} restart"
  celeryd[:pidfile] = File.join("/var/run/", file, ".pid")
  celeryd_list << celeryd
end

celeryd_list.each do |celeryd|
  God.watch do |w|
    w.name = celeryd[:name]
    w.interval = 30.seconds # default      
    w.start = celeryd[:start] 
    w.stop = celeryd[:stop]
    w.restart = celeryd[:restart]
    w.start_grace = 10.seconds
    w.restart_grace = 10.seconds
    w.pid_file = celeryd[:pidfile] 

    w.restart_if do |restart|
      restart.condition(:memory_usage) do |c|
        c.above = <%= @max_memory %>.megabytes
      end

      restart.condition(:cpu_usage) do |c|
        c.above = <%= @cpu %>.percent
        c.times = 5
      end
    end
  end
end
