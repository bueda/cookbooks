# Generated by Chef

God.contact(:campfire) do |c|
    c.name = "campfire"
    c.subdomain = "bueda"
    c.token = "63768eee94d96b7b18e2091f3919b2a2a3dcd12a"
    c.room = "Development"
end

celeryd_list = Array.new
Dir["/etc/init.d/celeryd-<%= @name %>_*"].each do |file|
    next if file.end_with? ".bak"
    celeryd = Hash.new
    celeryd[:name] = "#{file}"
    celeryd[:start] = "#{file} start"
    celeryd[:stop] = "#{file} stop"
    celeryd[:restart] = "#{file} restart"
    celeryd[:pidfile] = File.join("/var/run", "#{File.basename(file)}.pid")
    celeryd_list << celeryd
end

celeryd_list.each do |celeryd|
  God.watch do |w|
    w.name = celeryd[:name]
    w.interval = 30.seconds # default      
    w.start = celeryd[:start] 
    w.stop = celeryd[:stop]
    w.restart = celeryd[:restart]
    w.start_grace = 10.seconds
    w.restart_grace = 10.seconds
    w.pid_file = celeryd[:pidfile] 
    w.behavior(:clean_pid_file)

    w.start_if do |start|
        start.condition(:process_running) do |c|
            c.interval = 5.seconds
            c.running = false
            c.notify = 'campfire'
        end
    end

    w.restart_if do |restart|
      restart.condition(:memory_usage) do |c|
        c.above = 100.megabytes
      end

      restart.condition(:cpu_usage) do |c|
        c.above = 50.percent
        c.times = 5
      end
    end
  end
end
